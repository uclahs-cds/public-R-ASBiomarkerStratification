---
title: 'Active Surveillance Progression Prediction'
author: 'Stefan Eng'
output:
  bookdown::pdf_document2:
    keep_tex: true
  html_notebook: default
bibliography:  bibliography.bib
csl: european-urology.csl
nocite: |
  @BPG
---

```{r setup, include=FALSE}
library(ProstateCancer.ASBiomarkerSynergy);
library(BoutrosLab.plotting.general);
library(flextable);
library(gridExtra);
library(magrittr);
library(here);
library(caret);
library(pROC);
library(rpart.plot);

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, fig.align = 'center', out.width = '60%', fig.pos = 'H');

axis.cex <- .7
lab.cex <- .8
strip.cex <- 0.45

km.arguments <- list(
  xaxis.cex = axis.cex,
  yaxis.cex = axis.cex,
  main.cex = 1.4,
  xlab.cex = lab.cex,
  ylab.label = 'Estimated survival probability',
  ylab.cex = lab.cex,
  risktable.fontsize = 14,
  key.groups.cex = 1,
  key.stats.cex = 1,
  key.stats.y.pos = 0.5
  );

as.data <- default.load.data();
biodb <- as.data$biodb;

valid.patients <- biodb$NoUpgradeAndProgressed == 0 | is.na(biodb$NoUpgradeAndProgressed);

biodb.valid <- biodb[valid.patients, ];

reduced.vars <- c(
            'Age',
            'BMI',
            'Race',
            'Ethnicity',
            'ProstateVolume',
            'PCA3',
            'T2ERG',
            'MiPSCancerRisk',
            'MiPSHighGradeCancerRisk',
            'PercentFreePSA',
            'PHI',
            'GeneticRiskScore',
            'RSIlesionSignal',
            'RSIlesionPIRADS',
            'PSADensity',
            'PHIDensity'
            );
```

## Demographcs

```{r bx-biomarker-summary}
#library(dplyr)
#library(magrittr)
library(gtsummary)

attr(biodb$Ethnicity, 'label') <- 'Hispanic'
tbl_summary(biodb[, c(reduced.vars, 'BiopsyUpgraded')], by = BiopsyUpgraded) %>%
  add_p()
```

```{r, cache = TRUE}
seed <- 1313;
targets <- c(
    'BiopsyUpgraded',
    #'Prostatectomy',
    'ProgressedToTreatment'
    );
metric <- 'PR-AUC';
method <- 'gbm';
model.names <- c('everything', 'reduced_both', 'reduced_only_RSIlesionSignal', 'reduced_only_RSIlesionPIRADS');
model.nice.names <- c(
  'Full Model',
  'CR + RSI lesion signal and PI-RADS',
  'CR + RSI lesion signal',
  'CR + PI-RADS'
)
models <- lapply(targets, function(x) {
    model.id <- paste(x, metric, seed, sep = "_");
    model.id <- paste(model.id, model.names, sep = "_");
  
    model.files <- here(paste('models/gbm', model.id, 'model.RDS', sep = "_"));  
    names(model.files) <- model.nice.names;
    lapply(model.files, readRDS);
})
names(models) <- targets;

models.roc <- lapply(models, function(x) {
  lapply(x, function(m) {
      bestPreds <- with(m, merge(pred, bestTune));
      pROC::roc(predictor = bestPreds$yes, response = bestPreds$obs, direction = '<', levels = c('no', 'yes'));
  })
})

optimal.thresholds <- lapply(models.roc, function(rocs) {
  lapply(rocs, function(r) {
      as.numeric(coords(r, 'best')[1])
  })
})
```

```{r prediction-variables}
var.names <- models$BiopsyUpgraded[["Full Model"]]$finalModel$var.name

kable(
  var.names,
  col.names = 'Variables',
  booktabs = T,
  caption = 'Variables used in prediction for the full model') %>%
  kable_styling(position =  'center')
```

```{r prediction-variables-reduced}
var.names <- models$BiopsyUpgraded[[model.nice.names[[2]]]]$finalModel$var.name

kable(
  var.names,
  col.names = 'Variables',
  booktabs = T,
  caption = 'Variables used in prediction for the reduced model') %>%
  kable_styling(position =  'center')
```

```{r summary-table-bx}
summary.df <- summarize.models(models['BiopsyUpgraded'], models.roc['BiopsyUpgraded'])
cols <- c("model", "threshold", "Accuracy", "Sensitivity", "Specificity", "Precision", "F1")

thresholds.table <- summary.df[, cols]
# Break camel case into newlines
# thresholds.table$target <- kableExtra::linebreak(camel.to.spaces(thresholds.table$target, replace = "\n"), align = "c")
num.cols <- 2:length(cols)
thresholds.table[, num.cols] <- lapply(thresholds.table[, num.cols], function(x) round(as.numeric(x), 2))

upgrade.table <- flextable(thresholds.table) %>%
  add_footer_lines('CR = Clinically relevant variables') %>%
  set_caption('Models comparison between the full model, and clinically relevant models with RSI lesion signal and PI-RADS. Including RSI lesion signal improves the model greatly while adding RSI PI-RADS does not have much effect if RSI lesion signal is in the model. All of the statistics are averaged over the cross-validation folds and repetitions.') %>%
  autofit()
upgrade.table

save_as_docx(upgrade.table, path = here('euro_urology/tables/upgrade_table.docx'))
```

```{r variable-importance}
bx.upgrade.var.imp <- var.imp.combine(models$BiopsyUpgraded)

kable(x = bx.upgrade.var.imp[order(bx.upgrade.var.imp[,2], decreasing = TRUE), ],
      digits = 2,
      row.names = FALSE,
      caption = "Variable importance for Biopsy Upgraded") %>%
  kable_styling() %>%
  column_spec(2:5, width_min = "5em", width = "5em")
```



```{r cutpoint-days-prog-bx, fig.cap = 'Days to progression from biopsy for the prediction groups'}
prog.gbm.preds <- ifelse(predict(models$ProgressedToTreatment$`Full Model`, type = 'prob')[, 'yes'] > optimal.thresholds$ProgressedToTreatment$`Full Model`, 1, 0)

progression.surv.bx.valid <- do.call(
    what = survival::Surv,
    args = surv.format(biodb.valid$DaysBxToProgression, biodb.valid$DaysBxToLastReview)
    );

patient.groups <- as.factor(prog.gbm.preds[!is.na(progression.surv.bx.valid)]);
levels(patient.groups) <- c('No progression prediction', 'Predict progression');
do.call(
  what = BoutrosLab.plotting.survival::create.km.plot,
  args = c(
    km.arguments,
    list(
      # Is this right to remove the missing values?
      survival.object = progression.surv.bx.valid[!is.na(progression.surv.bx.valid)],
      patient.groups = patient.groups,
      main = 'Overall Days-to-Progression from Biopsy',
      xlab.label = 'Time to upgrade since biopsy (Days)'
      )
    )
  )
```
