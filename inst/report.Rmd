---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---

```{r setup, include=FALSE}
library(ProstateCancer.ASBiomarkerSynergy);
library(BoutrosLab.plotting.general);
library(kableExtra);
library(gridExtra);
library(magrittr);
library(here);
library(caret);

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, fig.align = 'center', out.width = '50%')

axis.cex <- .7
lab.cex <- .8
strip.cex <- 0.45

km.arguments <- list(
  xaxis.cex = axis.cex,
  yaxis.cex = axis.cex,
  main.cex = 1.4,
  xlab.cex = lab.cex,
  ylab.label = 'Estimated survival probability',
  ylab.cex = lab.cex,
  risktable.fontsize = 14,
  key.groups.cex = 1,
  key.stats.cex = 1,
  key.stats.y.pos = 0.5
  );

biodb <- default.load.data(onlyBiodb = TRUE);
```

## Introduction

There is a clinical need to predict *before* surgery if a man has aggressive disease so that we can decide if they need surgery at all.  The quality of life benefits are thus huge (avoiding therapy entirely!).  The problem is that because itâ€™s pre-surgery, we do not have the full cancer to study.  Instead we use biopsies (spatially-restricted samples of the cancer), radiology (imaging like MRI) and minimally-invasive biomarkers (e.g. blood or urine tests).  It's unclear which of those different strategies is best, and how those strategies should be sequenced or ordered.  A collaborator at UTHSCSA (University of Texas Health Sciences Center San Antonio) Dr. Michael Liss is a surgeon who is thinking hard about these problems.  He's put together a really nice cohort of ~100 patients where basically every possible biomarker has been generated and we want to figure out 'what is the optimal biomarker we can make using all tests'.  That will put an upper-bound to accuracy which we can go investigate in a prospective clinical trial.  We can then go backwards to start figuring out if there are ways to simplify/cheapen that test.

### Background

  - The Prostate Health Index (PHI): a new test for the detection of prostate cancer https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3943368
    - In multiple prospective international trials, this composite measurement has been shown to outperform conventional PSA and free PSA measurements.
    - Unlike PCA3 and TMPRSS2:ERG, PHI is also consistently associated with Gleason score and upgrading during active surveillance.

The Prostate Health Index (PHI) is computed as
$$
\text{PHI} = ([-2]\text{proPSA}/\text{free PSA}) \times \sqrt{\text{PSA}}
$$

In the data set this corresponds to `(p2PSA / freePSA) * sqrt(PSAHyb)`

## Data
In this cohort there are $N = `r nrow(biodb)`$ subjects.
There are three variables that are of interest to predict.
The first, `BiopsyUpgraded`, is whether the subject's research study biopsy increased cancer grade from the most recent biopsy results.
The second, `ProgressedToTreatment`, is whether the subject progressed to treatment.
Finally we have `Prostatectomy` which indicates whether the subject had a prostatectomy.

```{r}
pred.vars.xtabs <- xtabs(~ BiopsyUpgraded + ProgressedToTreatment + Prostatectomy, data = biodb, addNA = TRUE)
pred.vars.df <- as.data.frame(ftable(pred.vars.xtabs))

pred.table <- reshape(pred.vars.df, idvar = c('BiopsyUpgraded', 'ProgressedToTreatment'), timevar = 'Prostatectomy', direction = 'wide')

row.order <- with(pred.table, order(BiopsyUpgraded, ProgressedToTreatment))
prostatectomy.cols <- paste0(0:1, " (N=", table(biodb$Prostatectomy), ")")
overall.col <- paste0('Overall (N=', nrow(biodb), ')')

pred.table$Overall <- rowSums(pred.table[row.order, c(3,4)])

pred.table[row.order, ] %>%
  kable(row.names = FALSE,
    booktabs = TRUE,
    align =  c('c', 'c', 'c', 'c'),
    col.names = c('Biopsy Upgraded', 'Progressed To Treatment', prostatectomy.cols, overall.col),
    caption = "Comparision of prediction variables of interest") %>%
  kable_styling() %>%
  collapse_rows(columns = 1) %>%
  add_header_above(c(" " = 2, "Prostatectomy" = 2, " " = 1), align = 'c')
```

The severity of the prostate cancers were measured on the Gleason scale.
The variable `PreviousGleason` is the most recent prostate cancer Gleason score rating prior to research biopsy.
The Gleason score is computed again in the variable `StudyHighestGleason` after the research MRI.
We compare the progression of the cancers by the Gleason grades.
```{r}
progressed <- rep(NA, length(biodb$PreviousGleason))
progressed[biodb$PreviousGleason < biodb$StudyHighestGleason] <- "Increased";
progressed[biodb$PreviousGleason > biodb$StudyHighestGleason] <- "Decreased";
progressed[biodb$PreviousGleason == biodb$StudyHighestGleason] <- "No Change";

kable(t(table(progressed)), caption = "Comparision of pre-research biopsy Gleason score to post research MRI Gleason score");

with(biodb, {
  table(PreviousGleason, StudyHighestGleason, useNA='ifany') %>%
  kable(booktabs = TRUE,
    align =  'c') %>%
  kable_styling() %>%
  add_header_above(c(" " = 1, "Study Highest Gleason" = length(levels(StudyHighestGleason)) + 1), align = 'c')
})
```

### Demographics

#### Biopsy Upgraded
```{r, results= 'hide', out.width='90%'}
demographic.vars <- c("Age", "Weight", "Height", "BMI");
bx.plots <- lapply(demographic.vars, demographics.boxplot, biodb = biodb, x = "BiopsyUpgraded", cond = "Race", yaxis.cex = axis.cex, xaxis.cex = axis.cex, ylab.cex = lab.cex, xlab.cex = lab.cex, strip.cex = strip.cex);
do.call(gridExtra::grid.arrange, bx.plots);
```

#### Progressed to Treatment
```{r, results= 'hide', out.width='90%'}
demographic.vars <- c("Age", "Weight", "Height", "BMI");
prog.plots <- lapply(demographic.vars, demographics.boxplot, biodb = biodb, x = "ProgressedToTreatment", cond = "Race", yaxis.cex = axis.cex, xaxis.cex = axis.cex, ylab.cex = lab.cex, xlab.cex = lab.cex, strip.cex = strip.cex);
do.call(gridExtra::grid.arrange, prog.plots);
```

### Table Summaries
```{r}
# TODO: Update render.default to always include missing?
t1 <- table1::table1(~ p2PSA +  freePSA + PSAHyb + SOCPSA + PHI | ProgressedToTreatment, data = biodb);
table1.to.kable(t1) %>%
  add_header_above(c(" " = 1, "Progressed To Treatment" = 2, " " = 1))
```

```{r}
t1.bx <- table1::table1(~ p2PSA +  freePSA + PSAHyb + SOCPSA + PHI | BiopsyUpgraded, data = biodb);
table1.to.kable(t1.bx) %>%
  add_header_above(c(" " = 1, "Biopsy Upgraded" = 2, " " = 1))
```

### Correlation Heatmap
```{r, out.width = "100%"}
create.heatmap.AS(biodb);
```

### Time-to-event data

```{r}
stopifnot(
    all(!is.na(biodb$DaysDxToLastClinicalAppt))
    );
stopifnot(
    all(!is.na(biodb$DaysDxToLastReview))
    );
stopifnot(
    all(is.na(biodb$BiopsyResult) == is.na(biodb$DaysBxToLastReview))
    );
stopifnot(
    all(is.na(biodb$BiopsyResult) == is.na(biodb$DaysBxToLastClinicalAppt))
    );
```
All subjects have values for the days from diagnosis to the last clinical appointment `DaysDxToLastClinicalAppt` and last review `DaysDxToLastReview`.
The subjects that had a biopsy have values for variables `DaysBxToLastClinicalAppt` and `DaysBxToLastReview`.
If a subject progressed to treatment, then the days from diagnosis are in `DaysDxToProgression`.
If they had a biopsy and progressed to treatment then `DaysDxToProgression` will contain the days between the biopsy and progression.

#### Overall Days to Progression from Biopsy/Diagnosis
```{r}
# Create a Surv object from survival package
progression.surv.bx <- do.call(
    what = survival::Surv,
    args = surv.format(biodb$DaysBxToProgression, biodb$DaysBxToLastReview)
    );

progression.surv.dx <- do.call(
    what = survival::Surv,
    args = surv.format(biodb$DaysDxToProgression, biodb$DaysDxToLastReview)
    );

do.call(
  what = BoutrosLab.plotting.survival::create.km.plot,
  args = c(
    km.arguments,
    list(
      survival.object = progression.surv.bx,
      main = 'Overall Days-to-Progression from Biopsy',    
      xlab.label = 'Time to progression from biopsy (Days)'
      )
    )
  )

do.call(
  what = BoutrosLab.plotting.survival::create.km.plot,
  args = c(
    km.arguments,
    list(
      survival.object = progression.surv.dx,
      main = 'Overall Days-to-Progression from Diagnosis',
      xlab.label = 'Time to progression from diagnosis (Days)'
      )
    )
  )
```

#### Overall Time-to-Upgrade from Diagnosis
```{r}
# Create a Surv object from survival package
upgrade.surv <- do.call(
    what = survival::Surv,
    args = surv.format(biodb$DaysDxToUpgrade, biodb$DaysDxToLastReview)
    );

do.call(
  what = BoutrosLab.plotting.survival::create.km.plot,
  args = c(
    km.arguments,
    list(
      survival.object = upgrade.surv,
      main = 'Overall Days-to-Upgrade from Diagnosis',
      xlab.label = 'Time to upgrade since diagnosis (Days)'
      )
    )
  )
```

## Predictive Analysis
```{r}
seed <- 1010
model.names <- c('xgb', 'rpart', 'gbm')

model.file.names <- paste0('models/', model.names, '_ProgressedToTreatment_F_', seed, '_model.RDS')
prog.xgb.F.model <- readRDS(here(model.file.names[1]));
prog.rpart.F.model <- readRDS(here(model.file.names[2]));
prog.gbm.F.model <- readRDS(here(model.file.names[3]));

model.file.names <- paste0('models/', model.names, '_BiopsyUpgraded_F_', seed, '_model.RDS')
bx.xgb.F.model <- readRDS(here(model.file.names[1]));
bx.rpart.F.model <- readRDS(here(model.file.names[2]));
bx.gbm.F.model <- readRDS(here(model.file.names[3]));

model.file.names <- paste0('models/', model.names, '_Prostatectomy_F_', seed, '_model.RDS')
prostate.xgb.F.model <- readRDS(here(model.file.names[1]));
prostate.rpart.F.model <- readRDS(here(model.file.names[2]));
prostate.gbm.F.model <- readRDS(here(model.file.names[3]));
```

We predict the three variables: `ProgressedToTreatment`, `BiopsyUpgraded`, `Prostatectomy`.
For each of these variable we compare the results from three models: a regression tree (`rpart`), gradient boosting machine (`gbm`), and eXtreme Gradient Boosting (`xgboost`).
The regression tree model is the most interpretable as it produces a single decision tree.
The other models produce better accuracy as well as $F_1$ scores but require more work to interpret.

The following variables were used as the initial set of variables for `ProgressedToTreatment` and `Prostatectomy`. In the case of `BiopsyUpgraded`, the variable `BiopsyResult` was removed from the predictor variables.
```{r}
kable(prog.gbm.F.model$finalModel$var.names, col.names = "Variable")
```

### Prediction Results

#### Biopsy Upgraded
```{r}
bx.resamps <- resamples(
  list(XGB.F = bx.xgb.F.model,
       GBM.F = bx.gbm.F.model,
       rpart.F = bx.rpart.F.model));

trellis.par.set(caretTheme())
dotplot(bx.resamps, metric = c("F", "AUC-ROC", "AUPRC", "Accuracy", "Sens", "Spec"), main = "Biopsy Upgraded Model Comparision")

rpart.plot::rpart.plot(bx.rpart.F.model$finalModel)
```

#### Progressed To Treatment
```{r}
prog.resamps <- resamples(
  list(XGB.F = prog.xgb.F.model,
       GBM.F = prog.gbm.F.model,
       rpart.F = prog.rpart.F.model));

dotplot(prog.resamps, metric = c("F", "AUC-ROC", "AUPRC", "Accuracy", "Sens", "Spec"), main = "Progressed To Treatment Model Comparision")
rpart.plot::rpart.plot(prog.rpart.F.model$finalModel)
```

#### Prostatectomy
```{r}
prostate.resamps <- resamples(
  list(XGB.F = prostate.xgb.F.model,
       GBM.F = prostate.gbm.F.model,
       rpart.F = prostate.rpart.F.model));

dotplot(prostate.resamps, metric = c("F", "AUC-ROC", "AUPRC", "Accuracy", "Sens", "Spec"), main = "Prostatectom Model Comparision")

rpart.plot::rpart.plot(prostate.rpart.F.model$finalModel)
```


## Cut-points for survival analysis

### Progressed To Treatment
```{r}
prog.gbm.preds <- as.factor(predict(prog.gbm.F.model))
levels(prog.gbm.preds) <- c('0', '1')

do.call(
  what = BoutrosLab.plotting.survival::create.km.plot,
  args = c(
    km.arguments,
    list(
      survival.object = progression.surv.bx,
      patient.groups = prog.gbm.preds,
      main = 'Overall Days-to-Progression from Biopsy',
      xlab.label = 'Time to upgrade since biopsy (Days)'
      )
    )
  )

do.call(
  what = BoutrosLab.plotting.survival::create.km.plot,
  args = c(
    km.arguments,
    list(
      survival.object = progression.surv.dx,
      patient.groups = prog.gbm.preds,
      main = 'Overall Days-to-Progression from Diagnosis',
      xlab.label = 'Time to progression from diagnosis (Days)'
      )
    )
  )
```

### Days to Upgrade from Diagnosis
```{r}
bx.gbm.preds <- rep(NA, nrow(biodb))
bx.gbm.preds[!is.na(biodb$BiopsyUpgraded)] <- predict(bx.gbm.F.model)
bx.gbm.preds <- as.factor(bx.gbm.preds)
levels(bx.gbm.preds) <- c('0', '1')

do.call(
  what = BoutrosLab.plotting.survival::create.km.plot,
  args = c(
    km.arguments,
    list(
      survival.object = upgrade.surv,
      patient.groups = bx.gbm.preds,
      main = 'Overall Days-to-Upgrade from Diagnosis',
      xlab.label = 'Time to upgrade since diagnosis (Days)'
      )
    )
  )
```


## Variable Importance
```{r}
plot(varImp(prog.xgb.F.model), top = 25, main = "Variable Importance Progressed-to-Treatment XGB")
plot(varImp(bx.xgb.F.model), top = 25, main = "Variable Importance Biopsy Upgraded XGB")
plot(varImp(prostate.xgb.F.model), top = 25, main = "Variable Importance Prostatectomy XGB")

prog.model.list <- list(prog.xgb.F.model, prog.gbm.F.model, prog.rpart.F.model)
names(prog.model.list) <- c('xgb', 'gbm', 'rpart')

kable(compare.var.imp(prog.model.list, include.ranks = TRUE)[, -1], caption = "Variable importance (0-100) and rankings")
```
