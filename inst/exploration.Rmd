---
title: 'Data Exploration'
author: 'Stefan Eng'
date: '9/11/2020'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load the data analysis package and the data
```{r}
library(ProstateCancer.ASBiomarkerSynergy);
library(table1);
#library(pander);
library(knitr);

# Alternative table generation
#library(qwraps2);

#if(is_html_output()){
#    options(qwraps2_markup = 'markdown');
#    }

data <- default.load.data();
```

## Cohort Characteristics
```{r}
# library(dplyr)
table1::label(data$biodb$Height) <- 'Height (cm)';
table1::label(data$biodb$Weight) <- 'Weight (kg)';

cohort.table <- table1::table1(~ Age + Weight + Height + BMI | Race, data = data$biodb);
cohort.table;

table1::table1(~ Age + Weight + Height + BMI + Race | ProgressedToTreatment, data = data$biodb);
```

One person has 225 kg and no height... could be lbs instead?
```{r}
data$biodb[which.max(data$biodb$Weight), ]
```

## Scoring Variables
```{r}
factor.cols <- c('Race', 'Hispanic', 'MRIResult', 'HighestPIRADS',
                   'BiopsyResult', 'PreviousGleason', 'StudyHighestGleason', 'PreviousISUP', 'Observation',
                   'BiopsyUpgraded', 'GeneticAncestry', 'GeneticRiskCategory', 'GlobalScreeningArray',
                   'GSAPositives', 'BRCAMutation', 'RSIlesionPIRADS',
                   'RSIlesionCancer', 'RSIlesionGleason', 'RSIlesionISUP', 'RSIlesionUpgraded',
                   'RSIlesionObservation', 'ProgressedToTreatment', 'Prostatectomy',
                   'UpgradedAndProgressed', 'NoUpgradeAndProgressed')

score.cols <- c('MRIResult', 'MRILesions', 'BiopsyResult', 'PreviousGleason','PreviousISUP','StudyHighestGleason','StudyHighestISUP', 'RSIlesionPIRADS', 'HighestPIRADS')


# Something like this...
# str.match(score.cols, '([A-Z]+)([A-Z][a-z]+)([A-Z]*)')

score.formula <- as.formula(paste('~', paste0(score.cols, collapse = ' + '), '| ProgressedToTreatment'));

data$biodb$ProgressedFactor <- data$biodb$ProgressedToTreatment
levels(data$biodb$ProgressedFactor) <- c('No progression to Treatment', 'Progressed to Treatment');
table1::table1(score.formula, data = data$biodb);
```

One subject `M0003` has an `p2PSA` value of 1561. Update this to 15.61.
```{r}
# Missing decimal place
# data$biodb[3, 'p2PSA'] <- data$biodb[3, 'p2PSA'] / 100;
```

## Compute PHI
The Prostate Health Index (PHI) is computed as
$$
\text{PHI} = ([-2]\text{proPSA}/\text{free PSA}) \times \sqrt{\text{PSA}}
$$
The variable PHI is already in the dataset but to validate we computed ourselves.
Most of the subjects only differ slight errors but two subjects have a massive discrepancy between the computed PHI and the PHI given in the data set.

```{r}
psa.cols <- c('SOCPSA', 'PSAHyb', 'p2PSA', 'freePSA', 'PercentFreePSA', 'ProstateVolume', 'PSADensity', 'PHIDensity', 'PHI');

# Confirm PHI formula
PHI.computed <- with(data$biodb, {
    (p2PSA / freePSA) * sqrt(PSAHyb)
    });

psa.data <- cbind(data$biodb[, c('Record.ID', psa.cols)], PHI.computed);

phi.abs.error <- abs(data$biodb$PHI - round(PHI.computed, 1));

plot(
    phi.abs.error,
    ylab = 'PHI - [(p2PSA / freePSA) * sqrt(PSAHyb)]',
    xlab = 'Subject',
    las = 1
    );
```

We can see which of the patients have the large errors
```{r}
large.errors <- phi.abs.error > 1 & ! is.na(phi.abs.error);
psa.data[large.errors,c('Record.ID', 'p2PSA', 'freePSA', 'PSAHyb', 'SOCPSA', 'PHI', 'PHI.computed')];
```

## PSA Summary Statistics
```{r}
table1::table1(~ p2PSA +  freePSA + PSAHyb + SOCPSA + PHI + PHI.computed, data = psa.data, topclass='Rtable1-grid');
```

## Progression data
Some basic data validation on the ProgressedToTreatment and Days[BD]xToProgression
```{r}
progression.data <- data$biodb[, grepl('progress|review', colnames(data$biodb), ignore.case = TRUE)];
biopsy.result <- data$biodb$BiopsyResult;

progression.missing.dx <- progression.data$ProgressedToTreatment != as.numeric(! is.na(progression.data$DaysDxToProgression));
progression.missing.bx <- progression.data$ProgressedToTreatment != as.numeric(! is.na(progression.data$DaysBxToProgression));
if(! all(! progression.missing.dx)) {
    print('Subjects that progressed to treatment but missing DaysDxToProgression');
    progression.data[progression.missing.dx,]
    } else {
    print('No subjects that progressed to treatment are missing DaysDxToProgression')
    }
if(! all(! progression.missing.bx)) {
    print('Subjects that progressed to treatment but missing DaysBxToProgression');
    progression.data[progression.missing.bx,];
    } else {
    print('No subjects that progressed to treatment are missing DaysBxToProgression')
    }

# Check missingness of biopsy result with days to last review
stopifnot(
    all(is.na(biopsy.result) == is.na(progression.data$DaysBxToLastReview))
    );
```

## Check global screening array
```{r}
GSA <- data$biodb$GlobalScreeningArray
GSA.vars <- data$biodb[, c('GSAPositives', colnames(data$biodb)[grepl('Mutation', colnames(data$biodb))])]
# GSA.vars.num <- as.data.frame(lapply(GSA.vars, function(x) as.numeric(as.character(x))))

stopifnot({
    all(GSA == ifelse(rowSums(GSA.vars) > 0, 1, 0), na.rm = TRUE)
    });
```

## Check ISUP & Gleason Score

## Validity Check
Grade group is derived from Gleason score. Check that this is the case in the data.
We only need to include one of these variables.
```{r}
with(data$biodb, {
    print(table(StudyHighestISUP, StudyHighestGleason, useNA='ifany'));
    print(table(PreviousISUP, PreviousGleason, useNA='ifany'));
    print(table(RSIlesionISUP, RSIlesionGleason, useNA='ifany'));
    });
```

### Previous to Highest
```{r}
with(data$biodb, {
    print(table(PreviousGleason, StudyHighestGleason, useNA='ifany'));
    });
```

## Upgrade data
```{r}
upgrade.data <- data$biodb[, grepl('upgrade|review', colnames(data$biodb), ignore.case = TRUE)];

# Missing BiopsyUpgraded means that we won't have the days from biopsy to last review
stopifnot(
    all(is.na(upgrade.data$BiopsyUpgraded) == is.na(progression.data$DaysBxToLastReview))
    );

# Testing that the events return match if the biopsy was actually upgraded
stopifnot(
    all(is.na(surv.format(progression.data$DaysBxToProgression, progression.data$DaysBxToLastReview)$event) == is.na(upgrade.data$BiopsyUpgraded))
    );
```

## Correlations

```{r}
create.heatmap.AS(data$biodb);
```

Genetic Risk Category completely determined by Genetic Risk Score. Don't need to include both in analysis
```{r}
boxplot(GeneticRiskScore ~ GeneticRiskCategory, data = data$biodb);
```

  - MiPSCancerRisk is a biomarker using PSA, PCA3, T2ERG (Mi-Prostate Score High Grade Cancer Risk)
  - MiPSHighGradeCancerRisk is a biomarker using PSA, PCA3, T2ERG (Mi-Prostate Score High Grade Cancer Risk, Gleason Score >= 7)
  
```{r}
cor(x = data$biodb[, c('MiPSCancerRisk', 'MiPSHighGradeCancerRisk', 'PSAHyb', 'PCA3', 'T2ERG')],
    use = 'complete.obs',
    method = 'spearman'
    );

plot(MiPSHighGradeCancerRisk ~ MiPSCancerRisk, data = data$biodb);
```

## MRI Variables

Need to check if the observation variables are computed correctly. Not sure if observation is computed from `MRIPositive` and `BiopsyPositive` or something else.
```{r}
# cor(data$biodb$MRILesions, as.numeric(data$biodb$HighestPIRADS) - 1, method = 'spearman', use = 'complete.obs')

with(data$biodb, {
    print(table(MRILesions, HighestPIRADS, useNA = 'ifany'));
    });

observation.computed <- rep(NA, nrow(data$biodb));
MRIPositive <- data$biodb$MRIResult == 'Legion Found';
BiopsyPositive <- data$biodb$BiopsyResult == 'Positive';

observation.computed[MRIPositive & BiopsyPositive] <- 1;
observation.computed[MRIPositive & ! BiopsyPositive] <- 2;
observation.computed[! MRIPositive & BiopsyPositive] <- 3;
observation.computed[! MRIPositive & !BiopsyPositive] <- 4;

observation.computed <- as.factor(observation.computed)
levels(observation.computed) <- c(
    'MRI Positive/Biopsy Positive', 'MRI Positive/Biopsy Negative',
    'MRI Negative/Biopsy Positive', 'MRI Negative/Biopsy Negative'
    );

observation.df <-  cbind(
    data$biodb[, c('MRIResult', 'BiopsyResult' , 'Observation')],
    observation.computed,
    matches = observation.computed == data$biodb$Observation
    );

sum(! observation.df$matches, na.rm = T);

data$biodb[! observation.df$matches & ! is.na(observation.df$matches), ];
```

## Keeping Variables
```{r}
all.variables <- c('Record.ID', 'Age', 'Race', 'Hispanic', 'Weight', 'Height', 
    'BMI', 'SOCPSA', 'MRIResult', 'MRILesions', 'HighestPIRADS', 
    'BiopsyResult', 'ProstateVolume', 'PreviousGleason', 'PreviousISUP', 
    'StudyHighestGleason', 'StudyHighestISUP', 'Observation', 'BiopsyUpgraded', 
    'PCA3', 'T2ERG', 'MiPSCancerRisk', 'MiPSHighGradeCancerRisk', 
    'PSAHyb', 'freePSA', 'p2PSA', 'PercentFreePSA', 'PHI', 'GeneticAncestry', 
    'GeneticRiskScore', 'GeneticRiskCategory', 'GlobalScreeningArray', 
    'GSAPositives', 'BRCAMutation', 'TNFaAverage', 
    'TNFaSTD', 'RSInormalSignal', 'RSIlesionSignal', 'ADCnormalSignal', 
    'ADClesionSignal', 'RSIlesionPIRADS', 'RSIlesionCancer', 'RSIlesionGleason', 
    'RSIlesionISUP', 'RSIlesionUpgraded', 'RSIlesionObservation', 
    'ProgressedToTreatment', 'Prostatectomy', 'UpgradedAndProgressed', 
    'NoUpgradeAndProgressed', 'DaysBxToProgression', 'DaysBxToLastClinicalAppt', 
    'DaysBxToLastReview', 'DaysDxToUpgrade', 'DaysDxToProgression', 
    'DaysDxToLastClinicalAppt', 'DaysDxToLastReview', 'PSADensity', 
    'PHIDensity'
    );

biokey.variables <- c('Age', 'Race', 'Hispanic', 'Weight', 'Height', 
    'BMI', 'MRIResult', 'MRILesions', 'HighestPIRADS', 'BiopsyResult', 
    'ProstateVolume',  
     'Observation', 'BiopsyUpgraded', 'PCA3', 
    'T2ERG', 'MiPSCancerRisk', 'MiPSHighGradeCancerRisk', 'PSAHyb', 
    'freePSA', 'p2PSA', 'PercentFreePSA', 'PHI', 'GeneticAncestry', 
    # 'PreviousGleason', 'StudyHighestGleason', 'RSIlesionGleason', # Only use the ISUP grade group over Gleason
    'RSIlesionISUP', 'StudyHighestISUP', 'PreviousISUP', 
    'GeneticRiskScore',
    'TNFaAverage', 'TNFaSTD', # Tumor necrosis factor?
    #'GeneticRiskCategory', Don't need since genetic risk score is continuous version of this
    # 'GlobalScreeningArray', This is just an indicator if any of the follow are > 0
    'GSAPositives', 'BRCAMutation',
    'Mutation_BRCA1', 'Mutation_BRCA2', 'Mutation_ATM', 'Mutation_MLH1', 'Mutation_PMS2',
    'RSInormalSignal', 
    'RSIlesionSignal', 'ADCnormalSignal', 'ADClesionSignal', 'RSIlesionPIRADS', 
    'RSIlesionCancer',  'RSIlesionUpgraded', 
    'RSIlesionObservation', 'PSADensity', 'PHIDensity'
    );
```

Check how many of each mutation we have
```{r}
colSums(data$biodb[, c('Mutation_BRCA1', 'Mutation_BRCA2', 'Mutation_ATM', 'Mutation_MLH1', 'Mutation_PMS2')], na.rm = TRUE)

with(data$biodb, {
  print(table(ProgressedToTreatment, Mutation_BRCA1))
  print(table(ProgressedToTreatment, Mutation_BRCA2))
  print(table(ProgressedToTreatment, Mutation_ATM))
  print(table(ProgressedToTreatment, Mutation_MLH1))
  print(table(ProgressedToTreatment, Mutation_PMS2))
})
```

## Overall Days to Progression from Biopsy/Diagnosis
```{r}
# Create a Surv object from survival package
progression.surv.bx <- do.call(
    what = survival::Surv,
    args = surv.format(progression.data$DaysBxToProgression, progression.data$DaysBxToLastReview)
    );

progression.surv.dx <- do.call(
    what = survival::Surv,
    args = surv.format(progression.data$DaysDxToProgression, progression.data$DaysDxToLastReview)
    );

# plot(progression.surv.bx, main = 'Days to Progression from Biopsy');
# plot(progression.surv.dx, main = 'Days to Progression from Diagnosis');

BoutrosLab.plotting.survival::create.km.plot(
    survival.object = progression.surv.bx,
    xaxis.cex = 1.4,
    yaxis.cex = 1.4,
    xlab.label = 'Time to progression from biopsy (Days)',
    xlab.cex = 1.5,
    ylab.label = 'Estimated survival probability',
    ylab.cex = 1.5
    );

BoutrosLab.plotting.survival::create.km.plot(
    survival.object = progression.surv.dx,
    xaxis.cex = 1.4,
    yaxis.cex = 1.4,
    xlab.label = 'Time to progression from diagnosis (Days)',
    xlab.cex = 1.5,
    ylab.label = 'Estimated survival probability',
    ylab.cex = 1.5
    );
```

## Overall Time-to-Upgrade from Diagnosis
```{r}
# Create a Surv object from survival package
upgrade.surv <- do.call(
    what = survival::Surv,
    args = surv.format(upgrade.data$DaysDxToUpgrade, upgrade.data$DaysDxToLastReview)
    );

BoutrosLab.plotting.survival::create.km.plot(
    survival.object = upgrade.surv,
    xaxis.cex = 1.4,
    yaxis.cex = 1.4,
    xlab.label = 'Time to upgrade since diagnosis (Days)',
    xlab.cex = 1.5,
    ylab.label = 'Estimated survival probability',
    ylab.cex = 1.5
    );
```
